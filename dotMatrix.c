#include <LPC21XX.h>
#include "types.h"
#include "delay.h"
#include "defines.h"

u8 font[96][8]={ 
	{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, //space
	{0xE7, 0xC3, 0xC3, 0xE7, 0xE7, 0xFF, 0xE7, 0xFF}, //'!'
	{0x99, 0x99, 0x99, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, //'"'
	{0xC9, 0xC9, 0x80, 0xC9, 0x80, 0xC9, 0xC9, 0xFF}, //'#'
	{0xF7, 0xC1, 0xF5, 0xC1, 0xD7, 0xC1, 0xF7, 0xFF}, //'$'
	{0xFF, 0x9C, 0xCC, 0xE7, 0xF3, 0x99, 0x9C, 0xFF}, //'%'
	{0xE3, 0xC9, 0xE3, 0x91, 0xC4, 0xCC, 0x91, 0xFF}, //'&'
	{0xE7, 0xE7, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, //'''
	{0xCF, 0xE7, 0xF3, 0xF3, 0xF3, 0xE7, 0xCF, 0xFF}, //'('
	{0xF3, 0xE7, 0xCF, 0xCF, 0xCF, 0xE7, 0xF3, 0xFF}, //')'
	{0xFF, 0x99, 0xC3, 0x80, 0xC3, 0x99, 0xFF, 0xFF}, //'*'
	{0xFF, 0xE7, 0xE7, 0x81, 0xE7, 0xE7, 0xFF, 0xFF}, //'+'
	{0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xE7, 0xF3, 0xFF}, //','
	{0xFF, 0xFF, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0xFF}, //'-'
	{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF3, 0xF3, 0xFF}, //'.'
	{0x9F, 0xCF, 0xE7, 0xF3, 0xF9, 0xFC, 0xFE, 0xFF}, //'/'
	{0xC1, 0x9C, 0x8C, 0x84, 0x90, 0x98, 0xC1, 0xFF}, //'0'
	{0xE7, 0xE3, 0xE7, 0xE7, 0xE7, 0xE7, 0x81, 0xFF}, //'1'
	{0xC3, 0x99, 0x9F, 0xC7, 0xF3, 0x99, 0x81, 0xFF}, //'2'
	{0xC3, 0x99, 0x9F, 0xC7, 0x9F, 0x99, 0xC3, 0xFF}, //'3'
	{0xC7, 0xC3, 0xC9, 0xCC, 0x80, 0xCF, 0x87, 0xFF}, //'4'
	{0x81, 0xF9, 0xC1, 0x9F, 0x9F, 0x99, 0xC3, 0xFF}, //'5'
	{0xC7, 0xF3, 0xF9, 0xC1, 0x99, 0x99, 0xC3, 0xFF}, //'6'
	{0x81, 0x99, 0x9F, 0xCF, 0xE7, 0xE7, 0xE7, 0xFF}, //'7'
	{0xC3, 0x99, 0x99, 0xC3, 0x99, 0x99, 0xC3, 0xFF}, //'8'
	{0xC3, 0x99, 0x99, 0x83, 0x9F, 0xCF, 0xE3, 0xFF}, //'9'
	{0xFF, 0xF3, 0xF3, 0xFF, 0xFF, 0xF3, 0xF3, 0xFF}, //':'
	{0xF3, 0xF3, 0xFF, 0xFF, 0xF3, 0xF3, 0xF9, 0xFF}, //';'
	{0xE7, 0xF3, 0xF9, 0xFC, 0xF9, 0xF3, 0xE7, 0xFF}, //'<'
	{0xFF, 0xFF, 0x80, 0xFF, 0xFF, 0x80, 0xFF, 0xFF}, //'='
	{0xF9, 0xF3, 0xE7, 0xCF, 0xE7, 0xF3, 0xF9, 0xFF}, //'>'
	{0xE1, 0xCC, 0xCF, 0xE7, 0xF3, 0xFF, 0xF3, 0xFF}, //'?'
	{0xC1, 0x9C, 0x84, 0x84, 0x84, 0xFC, 0xE1, 0xFF}, //'@'
	{0xE7, 0xC3, 0x99, 0x99, 0x81, 0x99, 0x99, 0xFF}, //'A'
	{0xC0, 0x99, 0x99, 0xC1, 0x99, 0x99, 0xC0, 0xFF}, //'B'
	{0xC3, 0x99, 0xFC, 0xFC, 0xFC, 0x99, 0xC3, 0xFF}, //'C'
	{0xE0, 0xC9, 0x99, 0x99, 0x99, 0xC9, 0xE0, 0xFF}, //'D'
	{0x80, 0xB9, 0xE9, 0xE1, 0xE9, 0xB9, 0x80, 0xFF}, //'E'
	{0x80, 0xB9, 0xE9, 0xE1, 0xE9, 0xF9, 0xF0, 0xFF}, //'F'
	{0xC3, 0x99, 0xFC, 0xFC, 0x8C, 0x99, 0x83, 0xFF}, //'G'
	{0x99, 0x99, 0x99, 0x81, 0x99, 0x99, 0x99, 0xFF}, //'H'
	{0xC3, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xC3, 0xFF}, //'I'
	{0x87, 0xCF, 0xCF, 0xCF, 0xCC, 0xCC, 0xE1, 0xFF}, //'J'
	{0x98, 0x99, 0xC9, 0xE1, 0xC9, 0x99, 0x98, 0xFF}, //'K'
	{0xF0, 0xF9, 0xF9, 0xF9, 0xB9, 0x99, 0x80, 0xFF}, //'L'
	{0x9C, 0x88, 0x80, 0x80, 0x94, 0x9C, 0x9C, 0xFF}, //'M'
	{0x9C, 0x98, 0x90, 0x84, 0x8C, 0x9C, 0x9C, 0xFF}, //'N'
	{0xE3, 0xC9, 0x9C, 0x9C, 0x9C, 0xC9, 0xE3, 0xFF}, //'O'
	{0xC0, 0x99, 0x99, 0xC1, 0xF9, 0xF9, 0xF0, 0xFF}, //'P'
	{0xC3, 0x99, 0x99, 0x99, 0x89, 0xC3, 0x8F, 0xFF}, //'Q'
	{0xC0, 0x99, 0x99, 0xC1, 0x89, 0x99, 0x98, 0xFF}, //'R'
	{0xC3, 0x99, 0xF1, 0xE3, 0x8F, 0x99, 0xC3, 0xFF}, //'S'
	{0x81, 0xA5, 0xE7, 0xE7, 0xE7, 0xE7, 0xC3, 0xFF}, //'T'
	{0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xFF}, //'U'
	{0x99, 0x99, 0x99, 0x99, 0x99, 0xC3, 0xE7, 0xFF}, //'V'
	{0x9C, 0x9C, 0x9C, 0x94, 0x80, 0x88, 0x9C, 0xFF}, //'W'
	{0x9C, 0xC9, 0xE3, 0xF7, 0xE3, 0xC9, 0x9C, 0xFF}, //'X'
	{0x99, 0x99, 0x99, 0xC3, 0xE7, 0xE7, 0xC3, 0xFF}, //'Y'
	{0x80, 0x9C, 0xCE, 0xE7, 0xB3, 0x99, 0x80, 0xFF}, //'Z'
	{0xE1, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xE1, 0xFF}, //'['
	{0xFC, 0xF9, 0xF3, 0xE7, 0xCF, 0x9F, 0xBF, 0xFF}, //'\'
	{0xE1, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE1, 0xFF}, //']'
	{0xF7, 0xE3, 0xC9, 0x9C, 0xFF, 0xFF, 0xFF, 0xFF}, //'^'
	{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x80}, //'_'
	{0xF3, 0xF3, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, //'`'
	{0xFF, 0xFF, 0xE1, 0xCF, 0xC1, 0xCC, 0x91, 0xFF}, //'a'
	{0xF8, 0xF9, 0xF9, 0xC1, 0x99, 0x99, 0xC4, 0xFF}, //'b'
	{0xFF, 0xFF, 0xE1, 0xCC, 0xFC, 0xCC, 0xE1, 0xFF}, //'c'
	{0xC7, 0xCF, 0xCF, 0xC1, 0xCC, 0xCC, 0x91, 0xFF}, //'d'
	{0xFF, 0xFF, 0xE1, 0xCC, 0xC0, 0xFC, 0xE1, 0xFF}, //'r'
	{0xE3, 0xC9, 0xF9, 0xF0, 0xF9, 0xF9, 0xF0, 0xFF}, //'f'
	{0xFF, 0xFF, 0xE1, 0xCC, 0xCC, 0xC0, 0xCF, 0xE1}, //'g'
	{0xF8, 0xF9, 0xC9, 0x91, 0x99, 0x99, 0x98, 0xFF}, //'h'
	{0xF3, 0xFF, 0xF1, 0xF3, 0xF3, 0xF3, 0xE1, 0xFF}, //'i'
	{0xCF, 0xFF, 0xCF, 0xCF, 0xCF, 0xCC, 0xCC, 0xE1}, //'j'
	{0xF8, 0xF9, 0x99, 0xC9, 0xE1, 0xC9, 0x98, 0xFF}, //'k'
	{0xF1, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xE1, 0xFF}, //'l'
	{0xFF, 0xFF, 0xC9, 0x80, 0x80, 0x94, 0x9C, 0xFF}, //'m'
	{0xFF, 0xFF, 0xE0, 0xCC, 0xCC, 0xCC, 0xCC, 0xFF}, //'n'
	{0xFF, 0xFF, 0xE1, 0xCC, 0xCC, 0xCC, 0xE1, 0xFF}, //'o'
	{0xFF, 0xFF, 0xC1, 0x99, 0x99, 0xC1, 0xF9, 0xF1}, //'p'
	{0xFF, 0xFF, 0x91, 0xCC, 0xCC, 0xC1, 0xCF, 0x87}, //'q'
	{0xFF, 0xFF, 0xC4, 0x91, 0x99, 0xF9, 0xF0, 0xFF}, //'r'
	{0xFF, 0xFF, 0xC1, 0xFC, 0xE1, 0xCF, 0xE0, 0xFF}, //'s'
	{0xF7, 0xF3, 0xC1, 0xF3, 0xF3, 0xD3, 0xE7, 0xFF}, //'t'
	{0xFF, 0xFF, 0xCC, 0xCC, 0xCC, 0xCC, 0x91, 0xFF}, //'u'
	{0xFF, 0xFF, 0xCC, 0xCC, 0xCC, 0xE1, 0xF3, 0xFF}, //'v'
	{0xFF, 0xFF, 0x9C, 0x94, 0x80, 0x80, 0xC9, 0xFF}, //'w'
	{0xFF, 0xFF, 0x9C, 0xC9, 0xE3, 0xC9, 0x9C, 0xFF}, //'x'
	{0xFF, 0xFF, 0xCC, 0xCC, 0xCC, 0xC0, 0xCF, 0xE7}, //'y'
	{0xFF, 0xFF, 0xC0, 0xE6, 0xF3, 0xD9, 0xC0, 0xFF}, //'z'
	{0xC7, 0xF3, 0xF3, 0xF8, 0xF3, 0xF3, 0xC7, 0xFF}, //'{'
	{0xE7, 0xE7, 0xE7, 0xFF, 0xE7, 0xE7, 0xE7, 0xFF}, //'|'
	{0xF8, 0xF3, 0xF3, 0xC7, 0xF3, 0xF3, 0xF8, 0xFF}, //'}'
	{0x91, 0xC4, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, //'~'
};


u32 ANO=0, DATA=0;
extern u8 mode;

void initDOTMAT(u32 ano, u32 data){
	ANO=ano;
	DATA=data;
	
	WRITEBYTE(IODIR0, ANO, 0xFF);
	WRITEBYTE(IODIR0, DATA, 0xFF);
}


void SIPO_74LS164(u8 data, u8 mat){
	u8 i;
	u32 SIN=DATA+(2*mat);
	u32 CP=SIN+1;
	
	for(i=0; i<8; i++){
		READWRITEBIT2(IOPIN0, SIN, data, (7-i));
		SSETBIT(IOSET0, CP);
		delay_us(1);
		SCLRBIT(IOCLR0, CP);
		delay_us(1);
	}
}


void charDOTMAT(u8 ch, u8 mat, s32 dly){
	u32 i=0;
	
	while(dly--){
		if(mode=='1') break;
		for(i=0; i<8; i++){
			WRITEBYTE(IOPIN0, ANO, 0x00);
			SIPO_74LS164(font[ch-32][i], mat);
			WRITEBYTE(IOPIN0, ANO, (1<<i));
			delay_us(40);	
		}
		WRITEBYTE(IOPIN0, ANO, 0x00);
	}
}


void strDOTMAT(u8 *str, s32 dly){
	u32 i=0;
	
	while(dly--){
		if(mode=='1') break;
		for(i=0; i<8; i++){
			WRITEBYTE(IOPIN0, ANO, 0x00);
			
			// First Char
			SIPO_74LS164(font[str[0]-32][i], 0);
			
			// Second char
			if(str[1]=='\0'){
				SIPO_74LS164(font[0][i], 1);
				goto JUMP;
			}
			SIPO_74LS164(font[str[1]-32][i], 1);
			
			// Third char
			if(str[2]=='\0'){
				SIPO_74LS164(font[0][i], 2);
				goto JUMP;
			}
			SIPO_74LS164(font[str[2]-32][i], 2);
			
			// Fourth char
			if(str[3]=='\0'){
				SIPO_74LS164(font[0][i], 3);
				goto JUMP;
			}
			SIPO_74LS164(font[str[3]-32][i], 3);
			
			JUMP:
			WRITEBYTE(IOPIN0, ANO, (1<<i));
			delay_us(1000);	
		}
		WRITEBYTE(IOPIN0, ANO, 0x00);
	}
}


void scrollDOTMAT(u8 *str, s32 dly){
	u8 arr[7]="      ", i=0;
	
	arr[3]=str[0];
	arr[4]=str[1];
	arr[5]=str[2];
	
	for(i=0; i<3; i++){
		strDOTMAT(arr+i, dly);
	}
	
	while(*str){
		strDOTMAT(str, dly);
		str++;
	}
}

